# Risk Indicator (RI) Dashboard

Streamlit 建立的金融風險儀表板。上傳 Excel 後設定日期欄位、指標方向與權重，計算風險熱度並產出每日氛圍色帶、趨勢分析與貢獻度圖表，可下載處理後 CSV 與圖片。

## 專案概要

- 架構：單一 Streamlit 應用 [main.py](main.py)。
- 核心色彩系統：UI 主題色（紅色系主色、粉紅色、紫紅色）+ 風險等級色（綠/黃/橘紅/深紅）。
- 流程：上傳/讀取 Excel → 日期解析 → 指標選取 → 方向設定（越大越糟/越小越糟）與權重調整 → 方向一致化/正規化 → 加權合併得到 risk heat → 依門檻映射 Vibe（🟢 Calm/🟡 Neutral/🟠 Alert/🔴 Critical） → 計算驗證 → 視覺化展示與匯出。
- 主要函式：
  - `try_set_chinese_font()`：優先搜尋專案根目錄 → Windows 系統字體 → Linux 字體，載入中文字型解決方框問題。
  - `universal_date_parser()`：支援 YYYYMMDD、YYYY-MM-DD、YYYY/MM/DD、Excel serial（< 300000）、datetime 格式。
  - `apply_direction()`：根據方向標籤統一指標尺度；若「越大越糟」直接使用，若「越小越糟」反向為 max_val - x。
  - `normalize_minmax()`：0-1 最小最大正規化；常數列（無變化）回傳全 0。
  - `heat_to_vibe()`：根據 risk_heat 值與門檻模式映射為 Vibe（支援固定分段或歷史分位數）。
  - `get_risk_color()`：根據 Vibe 標籤返回對應的 RGB 色碼。
  - `load_excel()`：快取式 Excel 讀取，支援多工作表自動選擇或手動指定。
  - `build_template_df()`：產生 30 天隨機示範資料（包含 PD、NPL、VaR、流動性缺口等指標）。
- 視覺化：
  - **每日氛圍色帶圖**：橫向色帶展示整個時間序列，每日一格，顏色代表該日 Vibe 等級。
  - **風險熱度趨勢圖**：折線圖顯示 risk_heat 0-1 時間序列，背景填充 Calm/Neutral/Alert/Critical 四個區間（固定或動態分位數）。
  - **當日貢獻度圖**：水平長條圖排序顯示最新一日各指標正規化值 × 權重的絕對貢獻度，並標註數值。
- 計算驗證區塊：展開式顯示當日（最後一筆資料日期）的完整計算過程，逐項驗證貢獻度加總是否等於 risk_heat。
- 全域 CSS 樣式：統一字體、色系、卡片圓角、按鈕懸停效果、側邊欄背景、grid 網格線。

## 需求安裝

- Python 3.12（相容版本亦可）
- 依照 [requirements.txt](requirements.txt) 安裝：
  ```sh
  pip install -r requirements.txt
  ```

## 執行方式

1. 啟動服務：
   ```sh
   streamlit run main.py
   ```
2. 瀏覽器開啟 http://localhost:8501（預設），依介面指示上傳 Excel 或使用示範資料。

## 使用流程

### 側邊欄設置

1. **資料來源**：上傳 Excel 檔案或留空使用隨機模板（30 天示範資料）；可選指定工作表名稱。
2. **一般設定**：選擇風險等級門檻模式（固定分段 0.25/0.5/0.75 或歷史分位數 25%/50%/75%）；勾選是否顯示完整資料表。
3. **欄位對映**：系統自動偵測日期欄與數值欄；支援手動調整。
4. **指標方向與權重**：
   - 每個指標選擇方向：🔴 「越大越糟」（危險係數）或 🟢 「越小越糟」（安全係數）。
   - 調整權重滑桿（0-1），系統自動正規化使總和 = 1。
   - 方向說明顯示在資訊框內。

### 主區塊處理流程

1. **資料轉換詳情**：展開式表格顯示各指標的轉換率、原始範例、轉換範例，確保資料品質。
2. **資料清理**：移除空值，統計清理前後筆數；若清理後無資料，顯示可能原因與建議。
3. **統計摘要**：展開式表格顯示指標的描述統計（count、mean、std、min、max 等）。
4. **風險計算診斷**：
   - 第1步：原始數據統計表（方向、原始範圍、最新值、正規化後值、權重、貢獻度）。
   - 第2步：詳細轉換流程（原始最新值 → 方向轉換後 → 正規化後 → 加權貢獻）。
5. **計算驗證**：展開式表格逐項驗證當日（最後一筆日期）各指標貢獻度，並比對總和 vs. 系統計算的 risk_heat，結果顯示 ✅ 相符或 ❌ 不符。
6. **即時指標 KPI**：三個卡片式指標顯示最新日期、risk_heat 分數、當前 Vibe 等級與色塊。
7. **三大圖表**：色帶圖、趨勢圖、貢獻度圖逐一展示。
8. **下載結果**：四個按鈕提供 CSV、色帶 PNG、趨勢 PNG、貢獻度 PNG 下載。

### 風險等級映射

**固定分段模式**：

- heat < 0.25 → 🟢 Calm
- 0.25 ≤ heat < 0.5 → 🟡 Neutral
- 0.5 ≤ heat < 0.75 → 🟠 Alert
- heat ≥ 0.75 → 🔴 Critical

**歷史分位數模式**：

- heat < Q25 → 🟢 Calm
- Q25 ≤ heat < Q50 → 🟡 Neutral
- Q50 ≤ heat < Q75 → 🟠 Alert
- heat ≥ Q75 → 🔴 Critical

其中 Q25、Q50、Q75 為 risk_heat 序列的 25%、50%、75% 分位數。

## Excel 資料要求

- **日期欄位**（必備）：支援以下格式自動解析
  - 文字格式：YYYYMMDD（如 20250128）、YYYY-MM-DD、YYYY/MM/DD
  - Excel Serial 日期：小於 300000 的整數（自動轉換為日期）
  - Python datetime / pandas Timestamp
- **指標欄位**（至少一個）：
  - 必須為純數值欄位；含非數字文字（如「1公克」、「新台幣(TWD)」）的欄位會被過濾。
  - 系統自動偵測數值有效率 ≥ 80% 的欄位作為可選項。
  - 包含空值的行會在清理時移除。
- **其他**：
  - 權重全為 0 時，系統自動平均分配；否則自動正規化為總和 = 1。
  - 清理後若無有效資料，系統會顯示詳細的失敗原因與排查建議。

## 字型與中文顯示

系統自動優先搜尋順序：

1. **專案根目錄**：`NotoSansTC-Regular.ttf`（需手動下載放置）
2. **Windows 系統**：`C:\Windows\Fonts\msjh.ttc`（微軟正黑體）
3. **Linux 系統**：
   - `/usr/share/fonts/truetype/wqy/wqy-microhei.ttc`（文泉驿微米黑）
   - `/usr/share/fonts/truetype/noto/NotoSansCJK-Regular.ttc`（Noto Sans CJK）

若系統無法自動載入中文字型，側邊欄會顯示⚠️警告，建議：

- 下載 [NotoSansTC-Regular.ttf](https://fonts.google.com/) 放在專案根目錄
- 或於側邊欄上傳字型檔（ttf/otf/ttc 格式）

## 常見問題與故障排除

### 資料問題

- **部分日期無法解析**：
  - 症狀：介面警告「⚠ 部分日期無法解析（已自動移除）」。
  - 原因：日期欄包含非標準格式（如「時間不詳」、「待確認」）。
  - 解決：檢查原始 Excel，確保日期欄為純日期或標準文字格式（YYYYMMDD/YYYY-MM-DD/YYYY/MM/DD）。

- **清理後沒有有效數據**（❌ 錯誤訊息）：
  - 可能原因 1：所選指標欄位包含非純數字內容，系統過濾後剩無效資料。
  - 可能原因 2：日期欄無法解析，全數移除，導致清理後為空集合。
  - 可能原因 3：所有行都包含空值。
  - 解決建議：
    1. 在側邊欄「欄位對映」檢視自動偵測的「數值欄位」清單。
    2. 重新選擇「僅包含純數字」的指標（如價格、風險值、比率等，避免帶有單位的欄位）。
    3. 上傳新的 Excel 檔案並確保日期與指標欄無缺值或格式異常。

### 計算與驗證

- **計算驗證顯示 ❌ 不符**：
  - 症狀：展開「計算驗證」區塊，「計算驗證」指標顯示 ❌ 不符。
  - 原因：系統計算邏輯有誤或精度浮點誤差超過允許值（0.001）。
  - 解決：截圖報告此問題至 issue。

### 權重與方向

- **權重設定**：
  - 各指標的滑桿值會自動正規化，無需手動調整使其總和為 1。
  - 若所有滑桿值皆為 0，系統自動平均分配（每項 1/N）。
  - 修改滑桿後，圖表與計算會即時更新。

- **方向選擇說明**：
  - 🔴 **越大越糟**：危險指標，如違約率、呆帳率、風險值（VaR）等。數值越高 = 風險越高，正常使用。
  - 🟢 **越小越糟**：安全指標，如充足率、流動性、評分等。數值越低 = 風險越高，系統會自動反向為 max - x。

### 視覺化問題

- **中文方框**（方框符號代替中文字）：
  - 原因：系統未找到支援的中文字型。
  - 解決：
    1. 下載 `NotoSansTC-Regular.ttf` 並放在專案根目錄。
    2. 或於側邊欄上傳 ttf/otf/ttc 字型檔。
    3. 刷新頁面後字型應生效。

- **圖表無法正常顯示**：
  - 檢查 matplotlib 配置是否正確：確保 `mpl.rcParams` 已設置正確的色彩、字型、背景。
  - 若圖片保存失敗，檢查專案權限與硬碟空間。

### 匯出與下載

- **CSV 下載內容**：包含原始日期、選中的指標、正規化值、risk_heat、vibe、color 欄位；日期格式為 YYYY-MM-DD。
- **PNG 圖片**：三張圖以 200 DPI 解析度保存，支援工作流內嵌或外部報告使用。
- **Excel 模板下載**：示範資料包含日期欄與 5 個風險指標（PD、NPL、VaR、流動性缺口、EWS 分數），可用作上傳檔案的格式參考。

### 色彩系統參考

| 元素             | 顏色碼  | 用途                 |
| ---------------- | ------- | -------------------- |
| 品牌紅           | #9A0036 | 標題、邊框、主要強調 |
| 粉紅             | #EEBAC0 | 次要背景             |
| 紫紅             | #941C61 | 次要強調             |
| 金色             | #FFD700 | CTA 按鈕（正常狀態） |
| 橙色             | #FF8C00 | CTA 按鈕（懸停狀態） |
| 🟢 Calm 綠       | #10B981 | risk_heat < 0.25     |
| 🟡 Neutral 黃    | #F59E0B | 0.25 ≤ heat < 0.5    |
| 🟠 Alert 橘紅    | #EF4444 | 0.5 ≤ heat < 0.75    |
| 🔴 Critical 深紅 | #7F1D1D | heat ≥ 0.75          |
| 背景白           | #FFFFFF | 頁面主色             |
| 卡片淺灰         | #F5F5F5 | 區塊區分             |

## 版權聲明

© 2026 DunkLiao. All rights reserved.

本專案代碼與文檔均為 DunkLiao 所有。未經許可，禁止複製、修改、分發或用於商業用途。

如有任何問題或建議，歡迎提出 Issue 或 Pull Request。
